name: Check for Upstream Updates

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      comfyui_latest: ${{ steps.fetch.outputs.comfyui }}
      nunchaku_latest: ${{ steps.fetch.outputs.nunchaku }}
    steps:
      - name: Fetch Upstream Versions
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Get latest ComfyUI Release (using GitHub CLI for better reliability)
          # Note: ComfyUI uses tags like v0.2.4. Change to "main" if you prefer rolling release.
          COMFY_TAG=$(gh api repos/comfyanonymous/ComfyUI/releases/latest --jq .tag_name)
          
          # 2. Get latest Nunchaku Release
          NUN_TAG=$(gh api repos/nunchaku-tech/nunchaku/releases/latest --jq .tag_name)
          
          # 3. Safety Check - ensure we didn't get empty/null values
          if [ -z "$COMFY_TAG" ] || [ "$COMFY_TAG" == "null" ]; then
            echo "Error: Failed to fetch ComfyUI version"
            exit 1
          fi
          if [ -z "$NUN_TAG" ] || [ "$NUN_TAG" == "null" ]; then
            echo "Error: Failed to fetch Nunchaku version"
            exit 1
          fi

          echo "Latest ComfyUI: $COMFY_TAG"
          echo "Latest Nunchaku: $NUN_TAG"
          
          echo "comfyui=$COMFY_TAG" >> $GITHUB_OUTPUT
          echo "nunchaku=$NUN_TAG" >> $GITHUB_OUTPUT

      - name: Check Current Image Labels
        id: current
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository }}
        run: |
          sudo apt-get -y install skopeo jq
          
          FULL_IMAGE="$REGISTRY/$IMAGE_NAME:latest"
          
          # Inspect labels, defaulting to "none" if image doesn't exist
          INSPECT_JSON=$(skopeo inspect docker://$FULL_IMAGE 2>/dev/null || echo "{}")
          
          OLD_COMFY=$(echo $INSPECT_JSON | jq -r '.Labels["com.custom.version.comfyui"] // "none"')
          OLD_NUN=$(echo $INSPECT_JSON | jq -r '.Labels["com.custom.version.nunchaku"] // "none"')
          
          echo "Current Image ComfyUI: $OLD_COMFY"
          echo "Current Image Nunchaku: $OLD_NUN"
          
          echo "old_comfyui=$OLD_COMFY" >> $GITHUB_OUTPUT
          echo "old_nunchaku=$OLD_NUN" >> $GITHUB_OUTPUT

      - name: Compare Versions
        id: compare
        run: |
          NEW_C="${{ steps.fetch.outputs.comfyui }}"
          NEW_N="${{ steps.fetch.outputs.nunchaku }}"
          OLD_C="${{ steps.current.outputs.old_comfyui }}"
          OLD_N="${{ steps.current.outputs.old_nunchaku }}"
          
          if [ "$NEW_C" != "$OLD_C" ] || [ "$NEW_N" != "$OLD_N" ]; then
            echo "Updates detected! Triggering build."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "Versions match. No build needed."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  trigger-build:
    needs: check-versions
    if: needs.check-versions.outputs.should_build == 'true'
    uses: ./.github/workflows/build-publish.yml
    with:
      comfyui_version: ${{ needs.check-versions.outputs.comfyui_latest }}
      nunchaku_version: ${{ needs.check-versions.outputs.nunchaku_latest }}
    secrets: inherit
