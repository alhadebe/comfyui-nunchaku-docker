name: Build Ultimate ComfyUI

on:
  schedule:
    - cron: "0 */2 * * *" # Every 2 hours
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # Replace with your repo name
  IMAGE_NAME: ${{ github.repository }}/comfyui-ultimate
  COMFY_BRANCH: master
  NUNCHAKU_BRANCH: main

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Skopeo
        run: sudo apt-get -qq install -y skopeo jq

      # 1. Check Remote Repos
      - name: Check Remote SHAs
        id: remote
        run: |
          COMFY_SHA=$(git ls-remote https://github.com/comfyanonymous/ComfyUI.git refs/heads/${{ env.COMFY_BRANCH }} | cut -f1)
          NUN_SHA=$(git ls-remote https://github.com/nunchaku-tech/nunchaku.git refs/heads/${{ env.NUNCHAKU_BRANCH }} | cut -f1)
          echo "comfy_sha=$COMFY_SHA" >> "$GITHUB_OUTPUT"
          echo "nunchaku_sha=$NUN_SHA" >> "$GITHUB_OUTPUT"

      # 2. Check Previous Image Labels
      - name: Check Registry SHAs
        id: current
        continue-on-error: true
        run: |
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          if skopeo inspect docker://"$FULL_IMAGE" > /dev/null 2>&1; then
            JSON=$(skopeo inspect docker://"$FULL_IMAGE")
            OLD_COMFY=$(echo "$JSON" | jq -r '.Labels["comfyui.sha"] // empty')
            OLD_NUN=$(echo "$JSON" | jq -r '.Labels["nunchaku.sha"] // empty')
          else
             OLD_COMFY=""
             OLD_NUN=""
          fi
          echo "comfy_sha=$OLD_COMFY" >> "$GITHUB_OUTPUT"
          echo "nunchaku_sha=$OLD_NUN" >> "$GITHUB_OUTPUT"

      # 3. Determine if build needed
      - name: Decision
        id: check
        run: |
          BUILD="false"
          if [ "${{ steps.remote.outputs.comfy_sha }}" != "${{ steps.current.outputs.comfy_sha }}" ]; then
            echo "ComfyUI Changed."
            BUILD="true"
          fi
          if [ "${{ steps.remote.outputs.nunchaku_sha }}" != "${{ steps.current.outputs.nunchaku_sha }}" ]; then
            echo "Nunchaku Changed."
            BUILD="true"
          fi
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD="true"
          fi
          echo "build=$BUILD" >> "$GITHUB_OUTPUT"

      # 4. Build
      - name: Docker Login
        if: steps.check.outputs.build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.check.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        if: steps.check.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.ultimate
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # Use inline cache to speed up xFormers/FlashAttn rebuilds
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-to: type=inline
          build-args: |
            COMFYUI_REF=${{ steps.remote.outputs.comfy_sha }}
            NUNCHAKU_REF=${{ steps.remote.outputs.nunchaku_sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            comfyui.sha=${{ steps.remote.outputs.comfy_sha }}
            nunchaku.sha=${{ steps.remote.outputs.nunchaku_sha }}
